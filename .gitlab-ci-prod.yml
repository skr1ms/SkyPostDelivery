deploy:prod:
  stage: deploy
  image: alpine:3.20
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $FORCE_DEPLOY == "true"'
      when: on_success
    - if: '$CI_COMMIT_BRANCH == "main" && $FORCE_BUILD_ALL == "true"'
      when: on_success
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - .gitlab-ci.yml
        - gitlab-ci-*.yml
        - deployment/**/*
        - backend/go-orchestrator/**/*
        - backend/drone-service/**/*
        - admin_panel/**/*
        - Makefile
      when: on_success
    - when: never
  variables:
    DEPLOY_SERVER: $PROD_SERVER_IP
    DEPLOY_USER: $PROD_SERVER_USER
    DEPLOY_PATH: ${PROD_DEPLOY_PATH:-/opt/hitech}
    ENV_FILE: ${PROD_ENV_FILE:-.env.prod}
    COMPOSE_FILE: deployment/docker/docker-compose.cicd.yml
    SERVICES_TO_PULL: "go-orchestrator drone-service admin-panel"
  before_script:
    - apk add --no-cache git openssh-client bash ca-certificates docker-cli-compose
    - eval "$(ssh-agent -s)"
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh
    - ssh-keyscan "$DEPLOY_SERVER" >> ~/.ssh/known_hosts
  script:
    - |
      ssh "$DEPLOY_USER@$DEPLOY_SERVER" "set -euo pipefail && \
        mkdir -p '$DEPLOY_PATH' && \
        cd '$DEPLOY_PATH' && \
        if [ -d .git ]; then \
          git fetch origin main && git reset --hard origin/main; \
        else \
          git clone '$CI_REPOSITORY_URL' . && git checkout main; \
        fi"
    - |
      ssh "$DEPLOY_USER@$DEPLOY_SERVER" "set -euo pipefail && \
        cd '$DEPLOY_PATH' && \
        echo '$CI_JOB_TOKEN' | docker login '$CI_REGISTRY' -u gitlab-ci-token --password-stdin"
    - |
      ssh "$DEPLOY_USER@$DEPLOY_SERVER" "set -euo pipefail && \
        cd '$DEPLOY_PATH' && \
        export IMAGE_TAG='$CI_COMMIT_SHA' REGISTRY_IMAGE='$CI_REGISTRY_IMAGE' && \
        docker compose --env-file '$ENV_FILE' -f '$COMPOSE_FILE' pull $SERVICES_TO_PULL"
    - |
      ssh "$DEPLOY_USER@$DEPLOY_SERVER" "set -euo pipefail && \
        cd '$DEPLOY_PATH' && \
        export IMAGE_TAG='$CI_COMMIT_SHA' REGISTRY_IMAGE='$CI_REGISTRY_IMAGE' && \
        docker compose --env-file '$ENV_FILE' -f '$COMPOSE_FILE' up -d --remove-orphans"
    - |
      ssh "$DEPLOY_USER@$DEPLOY_SERVER" "cd '$DEPLOY_PATH' && docker compose --env-file '$ENV_FILE' -f '$COMPOSE_FILE' ps"
  environment:
    name: production
  tags: [prod]
  allow_failure: false
